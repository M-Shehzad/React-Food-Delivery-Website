create database fooddelivery;
use fooddelivery;
CREATE TABLE REGISTRY(
    USERNAME VARCHAR(20) PRIMARY KEY,
    PASSWORD VARCHAR(20) CHECK (PASSWORD RLIKE'^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])[a-zA-Z0-9]{8,}$'),
    EMAIL VARCHAR(40) CHECK (EMAIL RLIKE'^[a-zA-Z0-9\.]{5,30}@[a-zA-Z\.]{2,10}\.[a-z,A-Z]{2,4}')
);
alter table registry
add isAdmin boolean default false;

CREATE TABLE CUSTOMER(
    CUST_ID INT AUTO_INCREMENT PRIMARY KEY,
    NAME VARCHAR(20),
    PHONE_NO BIGINT,
    USERNAME VARCHAR(20),
    FOREIGN KEY (USERNAME) REFERENCES REGISTRY(USERNAME) ON DELETE CASCADE
);


CREATE TABLE ORDERS(
    ORDER_ID INT AUTO_INCREMENT PRIMARY KEY,
    ORDER_TIME DATETIME,
    CUST_ID INT,
    ADDRESS VARCHAR(60),
    FOREIGN KEY (CUST_ID) REFERENCES CUSTOMER(CUST_ID) ON DELETE SET NULL
);

CREATE TABLE PAYMENT(
    ORDER_ID INT PRIMARY KEY,
    PAYMENT_TYPE VARCHAR(10),
    PAYMENT_AMT INT,
    FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID) ON DELETE CASCADE
);



CREATE TABLE MENU(
    ITEM_NAME VARCHAR(20) PRIMARY KEY,
    CATEGORY VARCHAR(20),
    PRICE INT
);

CREATE TABLE ORDER_FROM(
    ORDER_ID INT,
    ITEM_NAME VARCHAR(20),
    QTY INT,
    FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID) ON DELETE CASCADE,
    FOREIGN KEY (ITEM_NAME) REFERENCES MENU(ITEM_NAME) ON DELETE SET NULL
);

//trigger implementation

DELIMITER $$
CREATE 
    TRIGGER TOT_AMT AFTER INSERT
        ON order_from
        FOR EACH ROW BEGIN
            DECLARE ITEM_PRICE INT;
            DECLARE QUANTITY INT;

            SET @ITEM_PRICE = (SELECT menu.PRICE FROM menu WHERE menu.ITEM_NAME = NEW.ITEM_NAME);
            SET @QUANTITY = NEW.QTY;

            UPDATE PAYMENT SET PAYMENT_AMT = IFNULL(PAYMENT_AMT,0) + @ITEM_PRICE*@QUANTITY WHERE ORDER_ID=NEW.ORDER_ID;
            END$$
DELIMITER ;